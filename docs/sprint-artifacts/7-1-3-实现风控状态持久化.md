# Story 7.1.3: 实现风控状态持久化

Status: done

## Story

As a **system**,
I want **risk control state to persist across restarts**,
so that **risk limits remain enforced even after bot restarts**.

## Acceptance Criteria

1. **AC1 – 在状态 JSON 中持久化 RiskControlState**  
   - 在 `core/state.py` 的 `save_state()` 中，将风控状态序列化为 `risk_control` 顶级字段写入 JSON。  
   - 使用 `core.risk_control.RiskControlState.to_dict()` 生成可 JSON 序列化的字典。  
   - `portfolio_state.json` 的顶层结构示例应为：
     - `balance: float`
     - `positions: dict`
     - `iteration: int`
     - `updated_at: str (ISO 8601, UTC)`
     - `risk_control: dict`（由 `RiskControlState.to_dict()` 生成）。

2. **AC2 – 从状态 JSON 中恢复 RiskControlState，兼容旧版本文件**  
   - 在 `core/state.py` 的 `load_state()` 中，读取 JSON 时：  
     - 如果存在 `risk_control` 字段：使用 `RiskControlState.from_dict(data["risk_control"])` 恢复风控状态。  
     - 如果不存在 `risk_control` 字段：使用 `RiskControlState()` 默认值初始化，确保旧版本 `portfolio_state.json` 仍可正常加载。  
   - 加载失败（JSON 损坏或字段类型异常）时：记录错误日志，但不会让 Bot 崩溃，回退到安全默认状态。

3. **AC3 – 使用原子写入保存状态文件**  
   - 在 `core/persistence.py` 的 `save_state_to_json()` 中，实现原子写入策略：  
     - 写入到临时文件（例如 `state_json.with_suffix(".tmp")`）。  
     - `json.dump()` 成功后再通过 `Path.replace()` 将临时文件原子性地替换正式文件。  
     - 发生异常时保留原有状态文件不变，并记录错误日志。  
   - 满足 PRD 中对「状态文件完整性」与「防止数据损坏」的非功能需求（NFR3）。

4. **AC4 – 单元测试覆盖风控状态持久化与兼容性**  
   - 新增或扩展测试文件（建议：`tests/test_risk_control_integration.py`），覆盖：  
     - 默认情况下保存的 JSON 中包含 `risk_control` 顶级字段，字段结构与 `RiskControlState.to_dict()` 一致。  
     - 从包含 `risk_control` 字段的 JSON 成功恢复 `RiskControlState`，字段值正确。  
     - 从不包含 `risk_control` 字段的旧 JSON 恢复时，使用默认值且不抛异常。  
     - 原子写入行为：写入过程中异常不会留下损坏的 JSON 文件（可通过模拟失败验证）。

5. **AC5 – 与现有状态结构和业务逻辑保持兼容**  
   - 不改变现有 `balance`、`positions`、`iteration` 字段的语义与格式。  
   - 不改变 `core/state.py` 对 `START_CAPITAL`、`TAKER_FEE_RATE` 等配置的加载行为。  
   - 风控状态的引入不会影响现有回测与 Dashboard 的读取逻辑（它们只依赖 CSV / 部分 JSON 字段）。

## Tasks / Subtasks

- [x] **Task 1 – 扩展 save_state 持久化 risk_control 字段（AC1, AC5）**  
  - [x] 1.1 在 `core/state.py` 中引入全局 `risk_control_state` 实例（类型为 `RiskControlState`）。  
  - [x] 1.2 在 `save_state()` 构建 payload 时，将 `risk_control_state.to_dict()` 作为 `risk_control` 顶级字段写入。  
  - [x] 1.3 确保未显式初始化风控状态时也有安全默认值（例如模块级默认实例）。

- [x] **Task 2 – 扩展 load_state 从 JSON 恢复 risk_control 字段（AC2, AC5）**  
  - [x] 2.1 在 `load_state()` 中读取 JSON 时，检查 `"risk_control"` 是否存在且为字典。  
  - [x] 2.2 若存在：调用 `RiskControlState.from_dict()` 恢复风控状态。  
  - [x] 2.3 若不存在：记录一条 INFO 日志，说明「旧版本状态文件，使用默认风控状态」。  
  - [x] 2.4 加载过程中出现解析错误时：捕获异常、记录 ERROR 日志，并回退到默认风控状态，不影响 Bot 启动。

- [x] **Task 3 – 在 core/persistence.py 中实现原子写入（AC3）**  
  - [x] 3.1 修改 `save_state_to_json()`：写入到临时文件（例如 `state_json.with_suffix(".tmp")`）。  
  - [x] 3.2 保证在 `json.dump()` 成功后再使用 `Path.replace()` 将临时文件替换正式文件。  
  - [x] 3.3 发生异常时删除临时文件并记录错误日志，不覆盖原有状态文件。  
  - [x] 3.4 添加必要的 `try/except`，使用现有日志模式（`logging.error`）。

- [x] **Task 4 – 为风控状态持久化新增单元测试（AC4）**  
  - [x] 4.1 为 `RiskControlState` 持久化路径编写集成测试（建议：`tests/test_risk_control_integration.py`）。  
  - [x] 4.2 测试从包含 `risk_control` 字段的 JSON 恢复完整状态。  
  - [x] 4.3 测试从不包含 `risk_control` 字段的 JSON 恢复时的兼容行为。  
  - [x] 4.4 使用临时目录 / 文件模拟原子写入过程，验证异常时原始文件未损坏。  
  - [x] 4.5 在测试中复用已有的 `RiskControlState` 单测模式和配置加载单测模式。

- [x] **Task 5 – 文档与结构检查（AC5）**  
  - [x] 5.1 确认新的 `risk_control` 字段符合 `docs/sprint-artifacts/tech-spec-epic-7-1.md` 中的示例结构。  
  - [x] 5.2 确认 `docs/prd-risk-control-enhancement.md` 中关于状态持久化的 FR1–FR4 已被满足或明确映射到本 Story。  
  - [x] 5.3 如有必要，在后续架构文档或 Epic 文档中补充「状态 JSON 中新增 risk_control 顶级字段」的说明。

## Dev Notes

### Requirements & Context Summary

- 本 Story 对应 **Epic 7.1: 风控状态管理基础设施** 中的 **Story 7.1.3: 实现风控状态持久化**：  
  - 目标：确保 `RiskControlState` 在 Bot 重启前后保持一致，满足 PRD 中 FR1–FR4 的需求。  
  - 范围：扩展 `core/state.py` 与 `core/persistence.py`，支持 `risk_control` 字段的读写。  
- PRD 《风控系统增强 - 产品需求文档》中的相关条目：  
  - **FR1–FR4：风控状态管理**  
    - FR1：系统维护全局风控状态（RiskControlState）。  
    - FR2：风控状态在每次迭代开始时加载，结束时保存。  
    - FR3：风控状态持久化到 `portfolio_state.json` 的 `risk_control` 字段。  
    - FR4：Bot 启动时检查并恢复上次风控状态。  
  - **NFR3：状态持久化使用原子写入，防止数据损坏**。  
- Tech Spec `tech-spec-epic-7-1.md` 已详细定义：  
  - `RiskControlState` 的字段结构与 `to_dict` / `from_dict` 实现模式。  
  - `portfolio_state.json` 新增 `risk_control` 顶级字段的示例。  
  - 与主循环、配置和持久化的集成点。

### Architecture & Implementation Constraints

- **模块边界**：  
  - 风控状态数据结构及其序列化逻辑集中在 `core/risk_control.py`。  
  - 状态 JSON 的读写集中在 `core/persistence.py`。  
  - 全局运行时状态（包括风控）由 `core/state.py` 负责协调。  
- **现有实现现状（在本 Story 之前）**：  
  - `core/state.save_state()` 当前只写入：`balance`、`positions`、`iteration`、`updated_at`。  
  - `core.persistence.save_state_to_json()` 直接对目标路径执行 `json.dump()`，未使用原子写入。  
  - `core.persistence.load_state_from_json()` 只返回 `balance`、`positions` 和 `iteration`，无 `risk_control` 解析。  
- **实现约束**：  
  - 遵循 `docs/architecture/06-project-structure-and-mapping.md` 对 `core/state.py` 与 `core/persistence.py` 的分工约定。  
  - 遵循 `docs/architecture/07-implementation-patterns.md` 中的实现模式：  
    - 使用 UTC + ISO 8601 时间戳。  
    - 不在业务代码中散落文件路径拼接逻辑，统一使用 `Path`。  
    - 错误处理以日志为主，尽量避免让 Bot 因状态文件异常崩溃。

### Learnings from Previous Story

**From Story 7-1-2-添加风控相关环境变量 (Status: done)**

- **New Files / Config Patterns**  
  - 新增 `tests/test_risk_control_config.py`，为风控相关配置提供系统化单元测试示例。  
  - 在 `config/settings.py` 中引入了统一的布尔 / 浮点解析 helper（例如 `_parse_bool_env`、`_parse_float_env_with_range`），并为 `RISK_CONTROL_ENABLED`、`KILL_SWITCH`、`DAILY_LOSS_LIMIT_ENABLED`、`DAILY_LOSS_LIMIT_PCT` 提供了默认值和合法范围校验。  
- **Patterns to Reuse**  
  - 默认安全（"secure by default"）策略：  
    - 风控整体与每日亏损限制默认启用，Kill-Switch 默认关闭。  
    - 非法配置值记录 warning 并回退到安全默认值。  
  - 测试组织方式：将配置相关测试集中在单独文件中，覆盖默认值、环境变量覆盖与非法输入回退。  
- **Implications for This Story**  
  - 持久化层不应重新解析环境变量，而是依赖 `config/settings.py` 中已经建立的配置常量与缺省策略。  
  - 在 Dev Notes 与实现中要明确：**环境变量配置优先于持久化状态**，尤其是 Kill-Switch 启动态等字段（参考 Tech Spec 风险章节和 7.1.2 的 Dev Notes）。  
  - 新增的持久化逻辑必须与现有配置加载逻辑协同工作：例如，当环境变量显式要求 Kill-Switch 激活时，即便状态文件中为关闭，也应以环境变量为准（这一细节可在后续 Story 中实现，这里需在设计上预留空间）。

### Project Structure Notes

- 预期受影响文件：  
  - `core/state.py` —— 增加风控状态的加载 / 保存逻辑，并与全局状态保持一致。  
  - `core/persistence.py` —— 更新 `save_state_to_json()` 使用原子写入，并为未来扩展（包括 `risk_control` 字段）提供安全的持久化基础。  
  - `tests/test_risk_control_integration.py`（新建，名称可根据实现时选择）：验证 `RiskControlState` 在 JSON 层面的持久化与恢复。  
- 不直接修改的相关文件（但需保持兼容）：  
  - `docs/architecture/06-project-structure-and-mapping.md` —— 已将状态持久化归入 `core/persistence.py`。  
  - `docs/architecture/07-implementation-patterns.md` —— 约定了状态文件结构应在架构文档中有说明；如有新增字段，后续 Story 或文档更新需补充说明。

### References

- [Source: docs/epic-risk-control-enhancement.md#Story-7.1.3-实现风控状态持久化]  
- [Source: docs/sprint-artifacts/tech-spec-epic-7-1.md#Detailed-Design]  
- [Source: docs/prd-risk-control-enhancement.md#功能需求]  
- [Source: docs/architecture/06-project-structure-and-mapping.md]  
- [Source: docs/architecture/07-implementation-patterns.md]

## Dev Agent Record

### Context Reference

- [7-1-1-定义-riskcontrolstate-数据结构.context.xml]  
- [7-1-2-添加风控相关环境变量.context.xml]  
- [7-1-3-实现风控状态持久化.context.xml]  
- [tech-spec-epic-7-1.context.xml]（如存在，由 Story Context 工作流生成）

### Agent Model Used

Claude 3.5 Sonnet (Cascade)

### Debug Log References (Planned)

- 在实现阶段建议记录以下关键日志：  
  - 状态加载：`Loaded state from {STATE_JSON} (balance=..., positions=..., has_risk_control=...)`。  
  - 风控状态加载：`Risk control state loaded: kill_switch_active={}, daily_loss_pct={:.2f}%`。  
  - 状态保存：`State saved atomically to {STATE_JSON}` 或错误日志。  
  - 兼容性路径：当检测到旧版本 JSON 无 `risk_control` 字段时，记录 INFO 日志说明兼容路径被触发。

### Completion Notes List

- 本 Story 已完成代码实现与测试，状态更新为 **done**。  
- ✅ 完成 `core/state.py` 与 `core/persistence.py` 的更新，实现 `risk_control` 字段持久化与原子写入。  
- ✅ 新增并通过 `tests/test_risk_control_integration.py`，覆盖 `risk_control` 字段的持久化与兼容性场景。  
- ✅ 通过 `./scripts/run_tests.sh`，全部 414 个测试通过（包含风控相关单元测试与集成测试）。

### Completion Notes
**Completed:** 2025-11-30
**Definition of Done:** All acceptance criteria met, code reviewed, tests passing

### File List

**NEW**  
- `tests/test_risk_control_integration.py` - 风控状态持久化与恢复集成测试。  

**MODIFIED**  
- `core/state.py` - 在 `load_state()` / `save_state()` 中集成 `RiskControlState`。  
- `core/persistence.py` - 为状态 JSON 写入实现原子写入，并支持 `risk_control` 字段。  

---

## Change Log

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 0.1 | 2025-11-30 | Bob (SM) | 初始 Story 草稿（通过 *create-story 工作流生成） |
| 0.2 | 2025-11-30 | Nick (Dev) | 按 Story 7.1.3 实现风控状态持久化（core/state.py, core/persistence.py, tests/test_risk_control_integration.py），并将状态更新为 review |
