# Story 6.5: 统一配置语义并为未来交易所留扩展点

Status: done

## Story

As a power user or infra engineer,
I want a consistent configuration model for selecting trading backends and enabling live mode,
So that switching or adding exchanges is predictable and low-risk.

本 Story 聚焦在**环境变量与文档层面**统一交易后端选择与实盘开关语义（`TRADING_BACKEND`、各 backend 的 live 开关与 API 变量），并为未来新增交易所适配器预留一套最小、可复用的接入规范。目标是让「从 paper → 单一实盘 backend → 新增 backend」的迁移路径在配置与文档上都清晰可控。

## Acceptance Criteria

1. **配置语义统一并文档化（TRADING_BACKEND / Live 开关）（AC1）**  
   - 在 `.env.example` 与 README 中，用清晰表格或小节描述：
     - `TRADING_BACKEND` 支持的枚举值：`paper` / `hyperliquid` / `binance_futures` / `<future>`；
     - 各 backend 需要的最小环境变量集合（Binance API、Hyperliquid 钱包与私钥等）；
     - 与实盘开关相关的布尔变量含义：`HYPERLIQUID_LIVE_TRADING`、`BINANCE_FUTURES_LIVE` 等，以及默认值和「安全默认行为」（未显式开启时保持 paper）。
   - README 的「Hyperliquid Live Trading」等章节与 `.env.example` 中的注释保持一致，不出现冲突描述或遗漏字段。

2. **为未来交易所定义最小接入规范（AC2）**  
   - 在文档中新增一节「如何新增一个交易所适配器」，以 checklist 形式给出：
     - 约定新的 `TRADING_BACKEND="<new_backend>"` 字符串；
     - 在 `.env.example` 中新增该 backend 所需的 live 开关与 API 配置（形如 `<BACKEND>_LIVE_TRADING`、API key/secret 等）；
     - 要求实现 `ExchangeClient` 接口，并在 `exchange_client.get_exchange_client` 工厂中挂接；
     - 要求新的 backend 在返回 `EntryResult` / `CloseResult` 时复用现有字段与错误语义（`backend`、`success`、`errors`、OID、`raw` 等）。
   - 该规范与 `docs/epics.md` 中 Epic 6 / Story 6.1–6.4 的抽象与 Dev Notes 保持一致，不引入矛盾术语。

3. **现有 backend 的配置矩阵清晰可见（AC3）**  
   - 在 README 或独立小节中给出一个简单矩阵/表格，列出：
     - 维度：`TRADING_BACKEND` × live 开关（paper / live）；
     - 对应行为：纸上交易、Hyperliquid 实盘、Binance Futures 实盘；
     - 关键风险提示（例如真实资金、最小资金规模、需要自行安装 `hyperliquid-python-sdk` 等）。
   - 表格示例中的值与当前实现一致（参考 `.env.example` 与 `README.md` 现有描述），避免误导性默认值。

4. **文档中引用统一的配置与扩展点位置（AC4）**  
   - 在 Story Dev Notes 或相关文档中，明确指向：
     - `.env.example` 作为配置字段权威列表；
     - `README.md` 中 backend / live 相关章节；
     - `docs/architecture/04-integrations.md` 与 `docs/architecture/06-project-structure-and-mapping.md` 中关于执行层与配置位置的章节（如果已有），让后续 Story 能快速找到扩展点。
   - 新增内容不破坏现有 PRD / 架构文档的语义，只做补充或交叉引用。

## Tasks / Subtasks

- [x] 任务 1：梳理现有 backend 配置与行为（AC: #1, #3）  
  - [x] 通读 `.env.example` 与 `README.md` 中与 `TRADING_BACKEND`、`HYPERLIQUID_LIVE_TRADING`、`BINANCE_FUTURES_LIVE`、资金与风险变量相关的部分，记录当前行为与默认值。  
  - [x] 对照 `docs/epics.md` Epic 6 概述与 Story 6.1–6.4，核对当前实现中的 backend 选择与行为是否与文档描述一致，标出需要在本 Story 内通过文档对齐的差异。

- [x] 任务 2：统一并补充配置文档（AC: #1, #3）  
  - [x] 在 `.env.example` 中，为 `TRADING_BACKEND` 及各 backend 的 live 相关变量补充简短、清晰的注释，说明推荐值与安全默认值。  
  - [x] 在 README 中新增或更新一小节「Trading Backend & Live Mode Configuration」，用表格形式描述：  
    - [x] 支持的 `TRADING_BACKEND` 值；  
    - [x] 需要设置的环境变量；  
    - [x] 是否会触达真实资金；  
    - [x] 参考的 smoke 测试脚本（如 `scripts/manual_hyperliquid_smoke.py`）。  

- [x] 任务 3：定义未来交易所接入规范（AC: #2, #4）  
  - [x] 在文档中新增「如何新增一个交易所适配器」小节，给出 Story 级 checklist：从约定 `TRADING_BACKEND` 值、扩展 `.env.example`、实现 ExchangeClient、扩展 `get_exchange_client` 到编写 smoke / 单元测试。  
  - [x] 明确要求新的 backend 复用现有 `EntryResult` / `CloseResult` 字段与错误语义，以便复用现有日志、CSV 与 Dev Notes 模式。  

- [x] 任务 4：交叉引用 PRD 与架构文档（AC: #3, #4）  
  - [x] 检查 `docs/PRD.md` 4.1 / 4.4 / 4.8 等章节，确认对 live 与 paper 模式的描述与最新配置文档一致；如有必要，补充一句「详见 README 的 backend 配置一节」。  
  - [x] 在 `docs/architecture/04-integrations.md` 或 `06-project-structure-and-mapping.md` 中，以最小改动方式标记「backend 配置入口」与 `ExchangeClient` 扩展点的文件路径与模块位置。

## Dev Notes

- 本 Story 建立在 Epic 6 以及 Story 6.1–6.4 已完成的抽象与重构工作之上，目标是**在配置与文档层面把「统一执行层」落到可操作的使用与扩展指南上**。  
- `.env.example` 已包含 `TRADING_BACKEND=paper`、`HYPERLIQUID_LIVE_TRADING`、`BINANCE_FUTURES_LIVE` 等变量；本 Story 需要让这些字段在 README / 架构文档中有一致且易于搜索的解释。  
- README 当前已经描述 Hyperliquid live 模式的开启条件及风险提示，本 Story 将在此基础上：  
  - 明确 paper / live / future backend 的完整矩阵；  
  - 强调「默认 paper、安全优先」的设计原则；  
  - 为未来新增 backend 提供一套复用 checklist，而不是一次性的临时说明。  

### Project Structure Notes

- 配置文件与示例：  
  - 根目录 `.env.example` 是所有环境变量的示例与注释入口。  
  - 实际运行时 `.env` 应与 `.env.example` 保持字段 superset。  
- 文档与架构：  
  - `docs/epics.md` 定义了 Epic 6 与 Story 6.1–6.5 的业务与技术边界。  
  - `docs/architecture/*.md` 描述执行层、外部依赖与项目结构，对本 Story 的扩展点（ExchangeClient、`bot.py`、`exchange_client.py`）提供全局视角。  
- 代码位置（供后续 Dev Story 使用）：  
  - `exchange_client.py`：ExchangeClient 抽象与具体 backend 适配器。  
  - `bot.py`：主交易循环与 `execute_entry` / `execute_close` 等执行入口，已在 Story 6.4 中重构为依赖 ExchangeClient。  

### References

- `docs/epics.md` — 「Epic 6: 统一交易所执行层 & 多交易所可插拔支持」与 「Story 6.5: 统一配置语义并为未来交易所留扩展点」。  
- `docs/PRD.md` — 尤其是 4.1「交易主循环（Bot）」与 4.8「Hyperliquid 实盘集成」。  
- `docs/architecture/index.md` 及 `docs/architecture/04-integrations.md`、`06-project-structure-and-mapping.md` — 外部集成点与项目结构。  
- 根目录 `.env.example` 与 `README.md` 中现有的 backend / live 配置说明。  

## Dev Agent Record

### Context Reference

- `docs/sprint-artifacts/6-4-将-execute-entry-execute-close-重构为使用-exchangeclient.context.xml`  
- `docs/sprint-artifacts/6-4-将-execute-entry-execute-close-重构为使用-exchangeclient.md`  
- `docs/sprint-artifacts/6-5-统一配置语义并为未来交易所留扩展点.context.xml`  

### Agent Model Used

- 本 Story 草稿由 Scrum Master Agent（SM / create-story 工作流）基于 Epic / PRD / 架构文档自动生成，输出语言为中文（Mandarin）。

### Debug Log References

- 2025-11-27：审阅 `.env.example` 与 `bot.py` 中的 `TRADING_BACKEND` / `HYPERLIQUID_LIVE_TRADING` / `BINANCE_FUTURES_LIVE` 解析逻辑，确认默认行为为「非法值与未配置均回退为 paper」，并记录 Hyperliquid / Binance Futures 实盘路径如何受 live 开关控制。  
- 2025-11-27：更新 `.env.example` 注释，明确 `TRADING_BACKEND` 支持的枚举值、各 backend 最小环境变量集合，以及 Hyperliquid / Binance Futures live 相关风控变量（MAX_RISK_USD / MAX_LEVERAGE / MAX_MARGIN_USD）在 paper 模式下被忽略。  
- 2025-11-27：在 README 中新增「Trading Backends & Live Mode Configuration」小节与 backend × live 矩阵，并补充 Hyperliquid / Binance Futures 的最小配置示例与 smoke test 脚本引用。  
- 2025-11-27：在 `docs/epics.md` 中为 Story 6.5 增加「如何新增一个交易所适配器」Checklist，要求未来 backend 通过 `ExchangeClient` 接口与 `get_exchange_client` 工厂挂接，并复用统一的 EntryResult / CloseResult 语义。  
- 2025-11-27：在 `docs/prd.md` 4.8 与 `docs/architecture/04-integrations.md`、`06-project-structure-and-mapping.md` 中添加交叉引用，指向 `.env.example` 与 README 的 backend 配置小节，以及 `exchange_client.py` / `bot.py` 作为扩展点。  
- 2025-11-27：尝试运行 `pytest` 作为回归测试入口，但在加载全局 pytest 插件 (`web3.tools.pytest_ethereum`) 时遇到环境级 ImportError：`cannot import name 'ContractName' from 'eth_typing'`，导致测试框架在收集前即失败；该错误来自当前 Python 环境的依赖版本不兼容，而非本 Story 的文档改动或仓库内代码变更。后续需要在环境层面升级/对齐 `eth_typing` 与相关 web3 依赖后再运行完整测试。  

### Completion Notes List

- [x] AC1：配置语义在 `.env.example` 与 README 中统一并文档化，涵盖所有现有 backend 与 live 开关。  
- [x] AC2：文档中新增未来交易所接入规范 checklist，复用 ExchangeClient 与统一结果结构。  
- [x] AC3：backend × live 行为矩阵清晰可见，并与当前实现一致。  
- [x] AC4：PRD 与架构文档中添加必要的交叉引用，指向配置入口与扩展点。  

### File List

- `.env.example`  — 更新并统一 backend / live 配置相关注释与默认值说明。  
- `README.md` — 新增「Trading Backends & Live Mode Configuration」小节与 backend × live 行为矩阵，并补充 Hyperliquid / Binance Futures 配置示例与 smoke test 引用。  
- `docs/epics.md` — 在 Epic 6 / Story 6.5 下新增「如何新增一个交易所适配器」Checklist。  
- `docs/prd.md` — 在 4.8 Hyperliquid 实盘集成小节中补充指向统一配置文档的引用。  
- `docs/architecture/04-integrations.md` — 标记 backend 配置入口为 `.env.example` 与 README 的相关小节。  
- `docs/architecture/06-project-structure-and-mapping.md` — 指出 `.env.example` / README 与 `exchange_client.py` / `bot.py` 是 backend 配置入口与扩展点。  
- `docs/sprint-artifacts/sprint-status.yaml` — 在本 Story 生命周期内更新 `6-5-统一配置语义并为未来交易所留扩展点` 的 `development_status`（ready-for-dev → in-progress → review）。  
- `docs/sprint-artifacts/6-5-统一配置语义并为未来交易所留扩展点.md` — 更新 Status、Tasks/Subtasks 复选框、Dev Agent Record 与 Change Log。  

## Change Log

- [x] 2025-11-27：初始 Story 草稿由 Scrum Master（create-story 工作流）根据 `docs/epics.md` / `docs/PRD.md` / `docs/architecture/*.md` 自动生成，状态设为 `drafted`，等待 Dev Agent 开始实施。  
- [x] 2025-11-27：Dev Agent 根据 Epic 6 / Story 6.5 的 AC1–AC4 完成 `.env.example`、`README.md`、`docs/epics.md`、`docs/prd.md`、`docs/architecture/04-integrations.md` 与 `docs/architecture/06-project-structure-and-mapping.md` 的更新，并在 `sprint-status.yaml` 与本 Story 文件中将状态标记为 `review`，准备进入 SM review。  
